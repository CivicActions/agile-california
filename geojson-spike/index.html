<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-dark.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>Chhs-geojson by RobertLRead</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>

    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>

    <script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' />


    <script src='https://api.mapbox.com/mapbox-gl-js/v0.18.0/mapbox-gl.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v0.18.0/mapbox-gl.css' rel='stylesheet' />
          
        

  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h1>Chhs-geojson</h1>
          <h2>Using the CHHS open data along with GeoJSON</h2>
        </header>

        <section id="downloads" class="clearfix">
          <a href="https://github.com/RobertLRead/chhs-geojson/zipball/master" id="download-zip" class="button"><span>Download .zip</span></a>
          <a href="https://github.com/RobertLRead/chhs-geojson/tarball/master" id="download-tar-gz" class="button"><span>Download .tar.gz</span></a>
          <a href="https://github.com/RobertLRead/chhs-geojson" id="view-on-github" class="button"><span>View on GitHub</span></a>
        </section>

        <hr>

        <section id="main_content">
          <h3>
	    <a id="welcome-to-github-pages" class="anchor" href="#welcome-to-github-pages" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Welcome to GitHub Pages.</h3>
	  <p>  This is a work in progress. </p>
	  
    <p> This is my attempt to both use the Socrata API and to use geojson at the same time.</p>

    <div>
    Zip Code: (Valid values are: 94604, 94621, 90017, 92867)
    <input type="text" id="zipcode"><br>
    <input type="button" onclick="redraw_with_zip(this)" value="Draw">Draw With zip</input>
    </div>

    <div id="facmap" style="width: 600px; height: 400px"></div>

	  <div id="faclist">
	    
	  </div>
	    
<h3>
<a id="support-or-contact" class="anchor" href="#support-or-contact" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Support or Contact</h3>

<p>Having trouble with Pages? Check out our <a href="https://help.github.com/pages">documentation</a> or <a href="https://github.com/contact">contact support</a> and weâ€™ll help you sort it out.</p>
        </section>

        <footer>
          Chhs-geojson is maintained by <a href="https://github.com/RobertLRead">RobertLRead</a><br>
          This page was generated by <a href="https://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.
        </footer>

        
      </div>
    </div>
  </body>
  <script>
    function GetURLParameter(sParam) {
    var sPageURL = window.location.search.substring(1);
    var sURLVariables = sPageURL.split('&');
    for (var i = 0; i < sURLVariables.length; i++)
    {
        var sParameterName = sURLVariables[i].split('=');
        if (sParameterName[0] == sParam)
        {
            return sParameterName[1];
        }
    }
    }
// Enter a url like this: http://127.0.0.1:4000/?zip=94621 to set zip from the URL
var zip_from_url = GetURLParameter('zip');
var default_zip = "92867";

var zip = zip_from_url || default_zip;

function redraw_with_zip() {
    zip = $("#zipcode").val();
    redraw();
}
var socrata_url = "https://chhs.data.ca.gov/resource/mffa-c6z5";
var geojson_snippet = ".geojson";
var facility_zip = "facility_zip";

// NOTE: This is for Ontario, California!!!
var home_long = -117.671471;
var home_lat = 34.085175;

// So this will be a geoJSON object, but for the first story I will just take it apart and render it...
var near_facilities;

var mapboxgl_accessToken = 'pk.eyJ1Ijoicm9iZXJ0bHJlYWQiLCJhIjoiY2lvcTkyejZtMDAxdHUzbTB0Z3R5MmIxZyJ9.wabsdiW8W9nY-48LRiclmw';

var map;

function render_near_facilities() {
    $("#faclist").html(JSON.stringify(near_facilities));


    L.mapbox.accessToken = 'pk.eyJ1Ijoicm9iZXJ0bHJlYWQiLCJhIjoiY2lvcTkyejZtMDAxdHUzbTB0Z3R5MmIxZyJ9.wabsdiW8W9nY-48LRiclmw';
    
    if (map) {
	map.remove();
    }
    
    map = L.mapbox.map('facmap', 'mapbox.streets')
    .setView([home_lat,home_long], 13);

    // Rather than do a geolocation, I'll take the means of the lat/longs in the feature list to center
    // the map...
    var cur_lat = 0.0;
    var cur_lon = 0.0;
    var num_features = near_facilities.features.length;
    var cnt = 0;
    for(var i = 0; i < num_features; i++) {
	var feature = near_facilities.features[i];
	feature.properties["title"] = feature.properties["facility_name"];
	feature.properties["marker-symbol"] = "cafe";
	feature.properties["marker-size"] = "large";
	if (feature.geometry.coordinates) { // WARNING: NOT SURE WHY THESE ARE SOMETIMES NULL --- bad data?
	    cnt++;
	    cur_lon += feature.geometry.coordinates[0];
	    cur_lat += feature.geometry.coordinates[1];
	    L.mapbox.featureLayer(
		near_facilities.features[i]
	    ).addTo(map);
	}
    }
    map.setView([cur_lat/cnt,cur_lon/cnt], 13);    
}




function query_zip_code(zip) {
    return socrata_url + geojson_snippet + "?" + facility_zip +"=" + zip;
}
// f is callback function on the data
function get_geojson_data_in_zip(socrata_url,geojson_snippet,facility_zip,zip,f) {
   var query = query_zip_code(zip);
    $.getJSON(query, f);
}

function redraw() {
        get_geojson_data_in_zip(socrata_url,geojson_snippet,facility_zip,zip,
						  // This is the success function, which we will almost certainly change!
			    function( data ) {
				near_facilities = data;
				render_near_facilities();
						  });
}

$(document).ready(function () {
    $("#zipcode").val(zip);
    redraw();
});

    </script>
</html>
